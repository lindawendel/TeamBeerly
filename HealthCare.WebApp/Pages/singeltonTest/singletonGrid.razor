@page "/grid"
@using Microsoft.AspNetCore.SignalR.Client
@using HealthCare.Core.Models
@inject IJSRuntime JSRuntime
@inject GridService GridService
@inject AppointmentService AppointmentService
@inject HttpClient Http

<h3>Grid</h3>
<table border="1">
    @foreach (var row in GridService.GetGrid())
    {
        <tr>
            @foreach (var cell in row)
            {
                <td>
                    <button @onclick="() => CellClicked(cell)" disabled="@(!cell.IsClickable)">@cell.Value</button>
                </td>
            }
        </tr>
    }
</table>

<h4>Click Events:</h4>
<ul>
    @foreach (var clickEvent in GridService.ClickEvents)
    {
        <li>@clickEvent.Time - ClickId @clickEvent.Id - Cell Clicked @clickEvent.Cell</li>
    }
</ul>

<button @onclick="ResetGrid">Reset Grid</button>


@*------------------------------------------------------------------------------------------------------------*@


<div id='calendar'></div>

<script src="/js/calendarInterop.js"></script>


<!-- Your Blazor component content -->
<!-- Include FullCalendar library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>

<!-- Include your custom JavaScript file -->
<script src="js/fullcalendar.js"></script>

<!-- Call the initializeCalendar function when needed -->
<button @onclick="@(async () => await InitializeFullCalendar("caregivers"))">Initialize Calendar</button>

@* @code {
    private async Task InitializeFullCalendar(string viewType)
    {
        await JSRuntime.InvokeVoidAsync("initializeCalendar", viewType);
    }
} *@



@code {
    private HubConnection hubConnection;
    private GridHub gridHub;
    private List<Appointment> availableAppointments;

    private async Task StartConnection()
    {
        if (hubConnection == null)
        {
            var hubConnectionBuilder = new HubConnectionBuilder();
            hubConnection = hubConnectionBuilder
                .WithUrl("https://localhost:7139/gridHub")
                .Build();

            hubConnection.On("ReceiveGridUpdate", async () =>
            {
                // Fetch updated appointments from the service
                availableAppointments = await AppointmentService.GetAvailableAppointments();

                // Notify FullCalendar to refresh events
                await JSRuntime.InvokeVoidAsync("initializeFullCalendar", availableAppointments);

                GridService.UpdateGrid();
                StateHasChanged();
            });

            gridHub = new GridHub(JSRuntime, hubConnection, AppointmentService);
            await gridHub.ConnectAsync();
            await gridHub.SendAsync("RequestGridUpdate");
        }
    }

    private void CellClicked(GridService.GridCell cell)
    {
        if (cell.IsClickable)
        {
            cell.IsClickable = false;
            GridService.UpdateGrid(); // Update the grid with the new clickable cells
            hubConnection.SendAsync("BroadcastGridUpdate");
        }
    }

    private void ResetGrid()
    {
        foreach (var clickEvent in GridService.ClickEvents)
        {
            clickEvent.IsClickable = true;
        }

        GridService.ResetGrid(); // Reset the grid and update clickable cells

        hubConnection.SendAsync("BroadcastGridUpdate");
    }

    protected override async Task OnInitializedAsync()
    {
        await StartConnection();
    }


    //-----------------------------------------------------------------------------------------------------



    //private List<Appointment> availableAppointments;

    private async Task InitializeFullCalendar(string viewType)
    {
        availableAppointments = await Http.GetFromJsonAsync<List<Appointment>>("/api/appointment/availableAppointments");
        await JSRuntime.InvokeVoidAsync("initializeFullCalendar", availableAppointments);
    }


}

