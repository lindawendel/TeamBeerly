@page "/my_page"
@attribute [Authorize]
@inject PatientService PatientService
@inject AppointmentService appointmentService
@inject HealthCareContext DbContext
@inject AuthenticationStateProvider AuthenticationStateProvider

<h3>My patient page</h3>

<div>
    <h5>Book an appointment</h5>
    <NavLink class="nav-link" href="appointment">To booking-schedule</NavLink>
</div>

<h4 class="MyPage">Personal</h4>

@if (!string.IsNullOrEmpty(profileImage))
{
    <img src="@profileImage" alt="Profile Image" />
}

<div class="PatientProfile">
    <p><label>Name: @patient.Name</label></p
    <p><label>Date of Birth: @patient.DateOfBirth.ToString("yyyy-MM-dd")</label></p
    <p><label>Phonenumber: @patient.PhoneNumber</label></p
    <p><label>Email: @patient.Email</label></p
    <NavLink class="nav-link" href="my_page/profile"> Edit Profile </NavLink>
</div>
    
<div class="upcomingPatientAppointments">
    <h5>Upcoming Appointments</h5>
    <ol>     
        @foreach (var appointment in UpcomingAppointments)
        {
            <li>
            <p>Date & Time: @appointment.StartTime</p>
            <p>Caregiver: @appointment.Caregiver.Name</p>
            <p> @appointment.Service</p>
            <p><NavLink class="nav-link" href="my_page"> Cancel appointment </NavLink></p>
            </li>
        }
        </ol>
</div>

<div class="pastPatientAppointments">
    <h5>Past Appointments</h5>
    <ol>
        @foreach (var appointment in PastAppointments)
        {
            <li>
            <p>Date & Time: @appointment.StartTime</p>
            <p>Caregiver: @appointment.Caregiver.Name</p>
            <p> @appointment.Service</p>
            </li>
        }
        </ol>
</div>
    
@code {
    private string profileImage;
    private List<Appointment> UpcomingAppointments = new List<Appointment>();
    private List<Appointment> PastAppointments = new List<Appointment>();
    private Patient patient;

    protected override async Task OnInitializedAsync()
    {
        patient = await PatientService.GetCurrentPatient();
        profileImage = await PatientService.GetProfilePicture();

        GetAppointments();
    }

   private void GetAppointments()
    {
        var now = DateTime.Now;

        if (patient != null)
        {
            UpcomingAppointments = DbContext.Appointments
                .Where(a => a.StartTime > now && a.Patient.Id == patient.Id)
                .Include(a => a.Caregiver)
                .OrderBy(a => a.StartTime)
                .ToList();

            PastAppointments = DbContext.Appointments
                .Where(a => a.StartTime < now && a.Patient.Id == patient.Id)
                .Include(a => a.Caregiver)
                .OrderByDescending(a => a.StartTime)
                .ToList();
        }
    }
}
